package me.raska.opendvs.core.service;

import java.util.Date;

import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import me.raska.opendvs.base.model.Vulnerability;
import me.raska.opendvs.base.model.poller.PollerAction;
import me.raska.opendvs.base.poller.amqp.PollerRabbitService;
import me.raska.opendvs.core.dto.PollerActionRepository;
import me.raska.opendvs.core.dto.VulnerabilityRepository;

@Service
public class VulnerabilityService {
    @Autowired
    private VulnerabilityRepository vulnerabilityRepository;

    @Autowired
    private PollerActionRepository actionRepository;

    @Autowired
    @Qualifier(PollerRabbitService.WORKER_QUALIFIER)
    private RabbitTemplate rabbitTemplate;

    public Page<Vulnerability> getVulnerabilities(Pageable page) {
        return vulnerabilityRepository.findAll(page);
    }

    public Vulnerability getVulnerability(String id) {
        return vulnerabilityRepository.findOne(id);
    }

    public PollerAction triggerCve(String modifier) {
        final PollerAction action = new PollerAction();
        action.setInitiated(new Date());
        action.setState(PollerAction.State.QUEUED);
        action.setFilter("cve:" + modifier);

        PollerAction act = actionRepository.save(action);

        rabbitTemplate.convertAndSend(act);

        return act;
    }
}
